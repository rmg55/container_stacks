FROM jupyter/scipy-notebook

#USER $NB_UID

#RUN conda uninstall --quiet --yes hdf5 netcdf4

USER root

RUN chmod -R 777 /home/jovyan
RUN mkdir /usr/share/jupyter
RUN mkdir /usr/share/jupyter/kernels
RUN mkdir /usr/share/jupyter/kernels/IDL
RUN chmod -R 777 /usr/share/jupyter
RUN chmod -R 777 /usr/share/jupyter/kernels
RUN chmod -R 777 /usr/share/jupyter/kernels/IDL
RUN chmod -R 777 /opt/conda/lib/python3.6/site-packages
RUN ln -s /usr/lib64/libreadline.so.6 /lib/x86_64-linux-gnu/libreadline.so.6

#RUN apt-get remove -y libhdf5-dev

#RUN apt-get install -y libmpich-dev

RUN apt-get update -y && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends libcr0 libcr-dev libmpich12 libmpich-dev libopenmpi-dev openmpi-bin openmpi-common openmpi-doc libgdal-dev openssh-client sshpass graphviz libhdf5-mpi-dev

#RUN pip install --quiet dask dask-ml bokeh mpi4py gdal tqdm bottleneck zarr numcodecs xarray ipywidgets
#RUN jupyter nbextension enable --py widgetsnbextension
#RUN jupyter labextension install @jupyter-widgets/jupyterlab-manager
#RUN jupyter labextension install dask-labextension

#RUN pip install --quiet netcdf4

RUN export TMPDIR=/local/scratch/$USER

RUN groupadd -g 1000 slurm
RUN useradd  -m -c "Slurm" -d /var/lib/slurm -u 401 -g slurm  -s /bin/bash slurm
RUN groupadd -g 398 munge
RUN useradd -m -c "Munge" -d /var/lib/munge -u 398 -g munge -s /sbin/nologin munge

USER $NB_UID

LABEL maintainer="Rowan Gaffney <rowan.gaffney@ars.usda.gov>"


# Install Python 3 packages
# Remove pyqt and qt pulled in for matplotlib since we're only ever going to
# use notebook-friendly backends in these images

RUN conda install --quiet --yes \
	'dask' \
	'dask-ml' \
	'bokeh' \
	'conda' \
	'mpi4py' \
	'gdal' \
	'git' \
	'pip' \
	'ncurses' \
	'netCDF4' \
	'tqdm' \
	'bottleneck' \
	'zarr' \
	'numcodecs' \
	'xarray'
RUN fix-permissions /home/$NB_USER
RUN fix-permissions $CONDA_DIR
RUN conda install -c conda-forge ipywidgets

RUN conda update --all --quiet --yes
RUN jupyter labextension install dask-labextension
RUN jupyter labextension update --all

#Run conda install --quiet --yes -c anaconda \
#	'netcdf4'

##Run conda install -c conda-forge --quiet --yes \
##	'dask=0.19.2' \
##	'dask-ml'


#RUN pip install --quiet dask[complete]
#RUN pip install --quiet dask-ml

RUN conda create --quiet --yes -n py6s-env -c conda-forge py6s

RUN pip install ipyleaflet \
  && jupyter nbextension enable --py --sys-prefix ipyleaflet

RUN jupyter labextension install jupyter-leaflet

RUN pip install --quiet earthengine-api

RUN pip install --quiet rasterio fiona spectral shapely pyshp shapely[vectorized] pyshp ipyparallel joblib psycopg2 openpyxl oauth2client PyDrive pyModis ulmo envipyengine dask-jobqueue
