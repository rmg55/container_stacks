FROM jupyter/scipy-notebook

USER root

RUN chmod -R 777 /home/jovyan
RUN mkdir /usr/share/jupyter
RUN mkdir /usr/share/jupyter/kernels
RUN mkdir /usr/share/jupyter/kernels/IDL
RUN chmod -R 777 /usr/share/jupyter
RUN chmod -R 777 /usr/share/jupyter/kernels
RUN chmod -R 777 /usr/share/jupyter/kernels/IDL
RUN chmod -R 777 /opt/conda/lib/python3.7/site-packages

#RUN apt-get update -y && \
#    apt-get upgrade -y && \
#    apt-get install -y --no-install-recommends libcr0 libcr-dev libmpich12 libmpich-dev libopenmpi-dev openmpi-bin openmpi-common openmpi-doc openssh-client sshpass graphviz libhdf5-mpi-dev libgdal-dev


RUN apt-get update -y && \
    apt-get upgrade -y
#    apt-get install -y --no-install-recommends libcr0 \
#    libcr-dev \
#    graphviz \
#    libhdf5-mpi-dev \
#    libmpich12 \
#    libmpich-dev \
#    libopenmpi-dev \
#    openmpi-bin \
#    openmpi-common \
#    libgdal-dev \
#    fonts-dejavu \
#    tzdata \
#    unixodbc \
#    unixodbc-dev \
#    r-cran-rodbc \
#    gfortran \
#    gcc && \
#    rm -rf /var/lib/apt/lists/*

    

#RUN apt-get update && \
#    apt-get install -y --no-install-recommends \
#    fonts-dejavu \
#    tzdata \
#    unixodbc \
#    unixodbc-dev \
#    r-cran-rodbc \
#    gfortran \
#    gcc && \
#    rm -rf /var/lib/apt/lists/*

# Fix for devtools https://github.com/conda-forge/r-devtools-feedstock/issues/4
RUN ln -s /bin/tar /bin/gtar

RUN export TMPDIR=/local/scratch/$USER

RUN groupadd -g 1000 slurm
RUN useradd  -m -c "Slurm" -d /var/lib/slurm -u 401 -g slurm  -s /bin/bash slurm
RUN groupadd -g 398 munge
RUN useradd -m -c "Munge" -d /var/lib/munge -u 398 -g munge -s /sbin/nologin munge

USER $NB_UID

LABEL maintainer="Rowan Gaffney <rowan.gaffney@ars.usda.gov>"


# Install Python 3 packages
# Remove pyqt and qt pulled in for matplotlib since we're only ever going to
# use notebook-friendly backends in these images

#RUN conda install -c conda-forge python-graphviz

#RUN conda update -c conda-forge --all
#RUN conda install -c ehsantn hdf5-parallel

RUN conda update conda

#RUN conda install --quiet --yes -c pyviz pyviz
#RUN conda install -c pyviz/label/dev --quiet --yes pyviz

RUN conda install -c conda-forge --quiet --yes \
	'dask' \
	'openmpi'\
	'dask-ml' \
	'bokeh' \
	'conda' \
	'mpi4py' \
	'gdal' \
	'git' \
	'pip' \
	'ncurses' \
	'netCDF4' \
	'tqdm' \
	'bottleneck' \
	'zarr' \
	'numcodecs' \
	'xarray' \
	'h5py>=2.9=mpi*' \
	'python-graphviz' \
	'geopandas' \
	'simplegeneric' \
	'rasterio' \
	'fiona' \
	'spectral' \
	'shapely' \
	'pyshp' \
	'joblib' \
	'psycopg2' \
	'openpyxl' \
	'oauth2client' \
	'PyDrive' \
	'dask-jobqueue' \
	'xgboost' \
	'earthengine-api' \
	'r' \
	'rpy2' \
	'poppler' \
	'intake' \
	'pydap' \
	'holoviews' \
	'geoviews' \
	'panel' \
	'datashader' \
	'streamz' \
	'rasterstats' \
	'pyarrow' \
	's3fs' \
	'gcsfs' \
	'intake-xarray' \
	'nb_conda_kernels'

# RUN conda update --all
# R packages


#RUN conda create -n R_geo -c conda-forge --quiet --yes \
#	'r-base' \
#	'r-rodbc' \
#	'unixodbc' \
#	'r-irkernel' \
#	'r-plyr' \
#	'r-devtools' \
#	'r-tidyverse' \
#	'r-shiny' \
#	'r-rmarkdown' \
#	'r-forecast' \
#	'r-rsqlite' \
#	'r-reshape2' \
#	'r-nycflights13' \
#	'r-caret' \
#    	'r-rcurl' \
#    	'r-crayon' \
#    	'r-randomforest' \
#	'r-htmltools' \
#	'r-sparklyr' \
#	'r-htmlwidgets' \
#	'r-hexbin' \
#	'r-maptools' \
#	'r-sp' \
#	'r-raster' \
#	'r-rgeos' \
#	'r-sf' \
#	'r-snow' \
#	'r-gstat' && \
#	conda clean -tipsy && \
#	fix-permissions $CONDA_DIR

#RUN conda config --add channels "conda-forge/label/cf201901"
#RUN conda install -n R_geo -c "conda-forge/label/cf201901" r-rgdal r-gdalutils

RUN pip install --quiet envipyengine pymodis

RUN fix-permissions /home/$NB_USER
RUN fix-permissions $CONDA_DIR
RUN conda install -c conda-forge ipywidgets

#RUN Rscript -e "install.packages('neonUtilities',repos = 'http://cran.us.r-project.org')"


RUN jupyter labextension install dask-labextension
RUN jupyter labextension install @pyviz/jupyterlab_pyviz
RUN jupyter labextension update --all

RUN pip install ipyleaflet \
  && jupyter nbextension enable --py --sys-prefix ipyleaflet

RUN jupyter labextension install jupyter-leaflet

#RUN pip install --quiet earthengine-api
RUN chmod -R 777 /opt/conda/lib/python3.7/site-packages
RUN conda init
